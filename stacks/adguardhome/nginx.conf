worker_processes auto;

events {
    worker_connections 4096;
}

stream {
    # SNI-based routing к оригинальным сайтам
    map $ssl_preread_server_name $upstream {
        # OpenAI domains
        chatgpt.com                    chatgpt.com:443;
        api.openai.com                 api.openai.com:443;
        auth.openai.com                auth.openai.com:443;
        platform.openai.com            platform.openai.com:443;
        openai.com                     openai.com:443;
        sora.com                       sora.com:443;
        
        # OpenAI static assets
        oaistatic.com                  oaistatic.com:443;
        oaiusercontent.com             oaiusercontent.com:443;
        
        # Auth/Identity
        auth0.com                      auth0.com:443;
        
        # Microsoft ecosystem
        microsoft.com                  microsoft.com:443;
        bing.com                       bing.com:443;
        
        # GitHub ecosystem
        github.com                     github.com:443;
        githubcopilot.com              githubcopilot.com:443;

        # Catch subdomains with ~
        ~^.*\.chatgpt\.com$            chatgpt.com:443;
        ~^.*\.openai\.com$             openai.com:443;
        ~^.*\.oaistatic\.com$          oaistatic.com:443;
        ~^.*\.oaiusercontent\.com$     oaiusercontent.com:443;
        ~^.*\.auth0\.com$              auth0.com:443;
        ~^.*\.microsoft\.com$          microsoft.com:443;
        ~^.*\.bing\.com$               bing.com:443;
        ~^.*\.github\.com$             github.com:443;
        ~^.*\.githubcopilot\.com$      githubcopilot.com:443;

        default                        1.1.1.1:443;
    }

    upstream openai {
        server chatgpt.com:443;
    }

    server {
        listen 443 reuseport;
        listen [::]:443 reuseport;
        
        proxy_pass $upstream;
        ssl_preread on;

        proxy_connect_timeout 10s;
        proxy_timeout 300s;
    }
}
